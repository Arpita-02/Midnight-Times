{% extends "base.html" %} 
{% load static %} 
{% load i18n %} 
{% block content %}

<style>
  body {
    background-image: url("{% static 'images/advarisk.jpeg' %}");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }

  /* Custom style for search results table */
  #search-results-table {
    background-color: white; /* Ensure table background is white */
  }
</style>

<div class="container">
  <div class="row">
    <div class="row">
      <div class="col-sm-12 d-flex justify-content-between align-items-center" id="search-results-table">
        <h2>Admin {{ object.name }}</h2>
        <div>
          <button id="add-button" class="btn btn-success ml-2">
            {% translate "Add User" %}
          </button>
          <button id="block-button" class="btn btn-danger ml-2">
            {% translate "Block User" %}
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-3" id="search-results-table">
    <div class="col-sm-12">
      <h3>Trending Keyword: <span id="trending-keyword"></span></h3>
    </div>
  </div>

  <div
    class="row mt-3"
    id="search-results-table"
    style="max-height: 75vh; overflow-y: auto"
  >
    <div class="col-sm-12">
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th scope="col" style="width: 20%">Author</th>
              <th scope="col" style="width: 30%">Title</th>
              <th scope="col" style="width: 50%">Description</th>
            </tr>
          </thead>
          <tbody id="search-results-body">
            <!-- Results will be dynamically added here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="row mt-3" id="user-action-form" style="display: none">
    <div class="col-sm-12">
      <div class="form-group">
        <label for="user-email">{% translate "User Email" %}</label>
        <input
          type="email"
          class="form-control"
          id="user-email"
          placeholder="Enter email"
        />
      </div>
      <div style="display: flex; gap: 10px">
        <button
          id="confirm-add-button"
          class="btn btn-success"
          style="display: none; margin-top: 10px"
        >
          {% translate "Confirm Add User" %}
        </button>
        <button
          id="confirm-block-button"
          class="btn btn-danger"
          style="display: none; margin-top: 10px"
        >
          {% translate "Confirm Block User" %}
        </button>
        <button
          id="cancel-add-button"
          class="btn btn-outline-secondary"
          style="display: none; margin-top: 10px"
        >
          {% translate "Cancel" %}
        </button>
      </div>
      <div
        id="response-message"
        style="margin-top: 10px; color: green; font-weight: bold"
      ></div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const accessToken = localStorage.getItem("access_token");
    const apiUrl = "http://127.0.0.1:8000/newsapp/api/background_search/";

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function callApi() {
      fetch(apiUrl, {
        method: "POST",
        headers: {
          Authorization: `token ${accessToken}`,
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          return response.json();
        })
        .then((data) => {
          // Display the trending keyword
          document.getElementById("trending-keyword").textContent =
            data.Trending_keyword;

          document.getElementById("search-results-table").style.display =
            "block";
          const searchResultsBody = document.getElementById(
            "search-results-body"
          );
          searchResultsBody.innerHTML = "";

          if (data.data.length === 0) {
            const noDataRow = document.createElement("tr");
            const noDataCell = document.createElement("td");
            noDataCell.setAttribute("colspan", "3");
            noDataCell.textContent = "No data available";
            noDataRow.appendChild(noDataCell);
            searchResultsBody.appendChild(noDataRow);
          } else {
            data.data.forEach((item) => {
              const row = document.createElement("tr");

              const authorCell = document.createElement("td");
              authorCell.textContent = item.author || "-";
              row.appendChild(authorCell);

              const titleCell = document.createElement("td");
              titleCell.textContent = item.title || "-";
              row.appendChild(titleCell);

              const descriptionCell = document.createElement("td");
              descriptionCell.innerHTML = item.description || "-";
              row.appendChild(descriptionCell);

              searchResultsBody.appendChild(row);
            });
          }
        })
        .catch((error) => {
          console.error("Error fetching API data:", error);
        });
    }

    function callAddApi(email) {
      fetch("http://127.0.0.1:8000/users/api/invitation/", {
        method: "POST",
        headers: {
          Authorization: `token ${accessToken}`,
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({ email: email }),
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          return response.json();
        })
        .then((data) => {
          document.getElementById(
            "response-message"
          ).textContent = `Successfully added ${email}`;
          setTimeout(() => {
            document.getElementById("response-message").textContent = "";
            callApi();
            document.getElementById("search-results-table").style.display =
              "block";
            document.getElementById("user-action-form").style.display = "none";
            document.getElementById("confirm-add-button").style.display =
              "none";
            document.getElementById("confirm-block-button").style.display =
              "none";
            document.getElementById("cancel-add-button").style.display = "none";
            document.getElementById("user-email").value = "";
          }, 5000);
        })
        .catch((error) => {
          console.error("Error calling Add API:", error);
        });
    }

    function callBlockApi(email) {
      fetch("http://127.0.0.1:8000/users/api/blockuser/", {
        method: "POST",
        headers: {
          Authorization: `token ${accessToken}`,
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({ email: email }),
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          return response.json();
        })
        .then((data) => {
          document.getElementById(
            "response-message"
          ).textContent = `Successfully blocked ${email}`;
          setTimeout(() => {
            document.getElementById("response-message").textContent = "";
            callApi();
            document.getElementById("search-results-table").style.display =
              "block";
            document.getElementById("user-action-form").style.display = "none";
            document.getElementById("confirm-add-button").style.display =
              "none";
            document.getElementById("confirm-block-button").style.display =
              "none";
            document.getElementById("cancel-add-button").style.display = "none";
            document.getElementById("user-email").value = "";
          }, 5000);
        })
        .catch((error) => {
          console.error("Error calling Block API:", error);
        });
    }

    document
      .getElementById("add-button")
      .addEventListener("click", function () {
        document.getElementById("search-results-table").style.display = "none";
        document.getElementById("user-action-form").style.display = "block";
        document.getElementById("confirm-add-button").style.display = "block";
        document.getElementById("confirm-block-button").style.display = "none";
        document.getElementById("cancel-add-button").style.display = "block";
      });

    document
      .getElementById("cancel-add-button")
      .addEventListener("click", function () {
        document.getElementById("search-results-table").style.display = "block";
        document.getElementById("user-action-form").style.display = "none";
        document.getElementById("confirm-add-button").style.display = "none";
        document.getElementById("confirm-block-button").style.display = "none";
        document.getElementById("cancel-add-button").style.display = "none";
        document.getElementById("user-email").value = "";
      });

    document
      .getElementById("block-button")
      .addEventListener("click", function () {
        document.getElementById("search-results-table").style.display = "none";
        document.getElementById("user-action-form").style.display = "block";
        document.getElementById("confirm-add-button").style.display = "none";
        document.getElementById("confirm-block-button").style.display = "block";
        document.getElementById("cancel-add-button").style.display = "block";
      });

    document
      .getElementById("confirm-add-button")
      .addEventListener("click", function () {
        const email = document.getElementById("user-email").value;
        if (email) {
          callAddApi(email);
        } else {
          alert("Please enter an email address.");
        }
      });

    document
      .getElementById("confirm-block-button")
      .addEventListener("click", function () {
        const email = document.getElementById("user-email").value;
        if (email) {
          callBlockApi(email);
        } else {
          alert("Please enter an email address.");
        }
      });

    callApi();
  });
</script>
{% endblock content %}
